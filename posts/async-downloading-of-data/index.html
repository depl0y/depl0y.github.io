<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Async downloading of data</title>
  <meta name="description" content="My post about using a NSURLConnection in a different thread has been read a lot. I made this post almost 3 years ago and I would like to show you how I would...">

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/main.css">
  
<!--  <link rel="stylesheet" href="/css/main.css"> -->
  <link rel="canonical" href="http://cocoa.ninja/posts/async-downloading-of-data">
  <link rel="alternate" type="application/rss+xml" title="cocoa.ninja" href="http://cocoa.ninja/feed.xml" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>	    
      <a class="navbar-brand" href="/">
         cocoa.ninja
      </a>
    </div>
  
	  <div class="collapse navbar-collapse">
	      <ul class="nav navbar-nav navbar-right">
		      <li>
			  	<a href="https://twitter.com/depl0y">
					<img src="/img/svg/twitter.svg">
				</a>
	        
			</li>
	     
			<li class="icon  icon--github">
				<a href="https://github.com/depl0y">
					<img src="/img/svg/github.svg">
				</a>
			</li>	 
		
		
			<li class="icon icon--mail">
				<a href="mailto:wim@sortedbits.com">
					<img src="/img/svg/mail.svg">
				</a>
			</li>
			
			<li class="icon icon--so">
				<a href="http://stackoverflow.com/users/69313/wim-haanstra">
					<img src="/img/svg/stackoverflow.svg">
				</a>
			</li>
			
			
			<li class="icon icon--so">
				<a href="skype:wimhaanstra" id="skype_call_wim">
					<img src="/img/svg/skype.svg">
				</a>
			</li>
	  	</ul>
	  </div>
  </div>
</nav>


    <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Async downloading of data</h1>
  </header>
</div>

<div class="post-info">
	<div class="author-avatar">
		<img src="http://www.gravatar.com/avatar/0ec84fc5efb4f0dc7db5df8bf6bb41b9.png">
	</div>
	<div class="details">
		<div class="row">
			<div class="col-md-12 author-name">
				Wim Haanstra
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 post-subtitle">
				This post was created on <span class="post-date">December 7, 2011</span>.
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 tags">
		   		
		   			<span class="tag">objC</span>
		   		
			</div>
		</div>
	</div>
</div>


<div class="post">
  <article class="post-content">
    <p>My post about using a NSURLConnection in a different thread has been read a lot. I made this post almost 3 years ago and I would like to show you how I would solve it nowadays. In the last 3 years I have learned a lot and the cocoa-touch framework evolved too.</p>

<!-- more -->

<p><strong>This code shows you HOW to achieve something and it is not intended as a copy-paste solution.</strong></p>

<p>Between that post and now I have been trying out frameworks that support async operations and after using <a href="http://allseeing-i.com/ASIHTTPRequest/">ASIHTTPRequest</a> for a long time, it was time to move on (the project was discontinued).</p>

<p>After trying out several more, I came across <a href="https://github.com/lukeredpath/LRResty">LRResty</a>, which is a nice framework designed with <a href="http://developer.apple.com/library/ios/#documentation/cocoa/Conceptual/Blocks/Articles/00_Introduction.html">code-blocks</a> in mind.</p>

<p>Here is a small example of a piece of code, which is taken directly form the <a href="http://projects.lukeredpath.co.uk/resty/documentation.html">LRResty documentation page</a>:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="lineno">1</span> <span class="p">[[</span><span class="n">LRResty</span> <span class="n">client</span><span class="p">]</span> <span class="nl">get</span><span class="p">:</span><span class="s">@&quot;http://www.example.com&quot;</span>
<span class="lineno">2</span>             <span class="nl">withBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">LRRestyResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">3</span> 
<span class="lineno">4</span>     <span class="k">if</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">5</span>       <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Successful response %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">response</span> <span class="n">asString</span><span class="p">]);</span>
<span class="lineno">6</span>     <span class="p">}</span>
<span class="lineno">7</span> <span class="p">}];</span></code></pre></div>

<p>This piece of code fetches the content of an URL (www.example.com) and when the response comes back, it checks if the response is OK (status code 200). When it is, it does a simple NSLog.</p>

<p>Here you can see the power of code-blocks already. You define the way it handles a responses directly when you do the request, in my opinion this keeps code clean and simple.</p>

<p>Now we can take this a step further and see what happens if we launch this in a new thread. For this example I am taking a piece of code of an actual library I was writing some time ago, it involves getting some data through the GitHub API, waiting for the response and then executing a certain piece of code, while this can be a bit overwhelming at first, it sure beats writing dozens of extra methods for each response.</p>

<p>Because we are going the be launching the request from another thread, we have to take <a href="http://en.wikipedia.org/wiki/Race_condition">race conditions</a> into account, this was a bug that hit me when I was first using code-blocks and multi-threading.</p>

<p>I created a method which can be called with a single NSDictionary as parameter, containing code-blocks and other stuff which it needs to perform the request. Because the GitHub API needs authentication also, I will also show how that works. The dictionary contains 3 objects with the keys ‘success’, ‘failed’ and ‘url’.</p>

<p>The objects linked to the ‘success’ and ‘failed’ keys are code-blocks, I will show the contents later.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="lineno"> 1</span> <span class="c1">// This method performs the actual request and can be called in a different thread.</span>
<span class="lineno"> 2</span> <span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">startRequest:</span><span class="p">(</span><span class="bp">NSDictionary</span><span class="o">*</span><span class="p">)</span> <span class="nv">parameters</span>
<span class="lineno"> 3</span> <span class="p">{</span>
<span class="lineno"> 4</span> <span class="c1">// Take the URL out of the dictionary and store it in a NSString object.</span>
<span class="lineno"> 5</span> 	<span class="bp">NSString</span><span class="o">*</span> <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="s">@&quot;url&quot;</span><span class="p">];</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="c1">// Get both the &#39;success&#39; and &#39;failed&#39; code-blocks from the dictionary</span>
<span class="lineno"> 8</span> 	<span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">success</span><span class="p">)(</span><span class="n">LRRestyResponse</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="s">@&quot;success&quot;</span><span class="p">];</span>
<span class="lineno"> 9</span> 	<span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">failed</span><span class="p">)(</span><span class="n">LRRestyResponse</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="s">@&quot;failed&quot;</span><span class="p">];</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="c1">// Check if there already is a client active in this class and if not, check if authentication is set.</span>
<span class="lineno">12</span> <span class="c1">// If not, just raise an exception for now.</span>
<span class="lineno">13</span> 	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">nil</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="nb">self</span><span class="p">.</span><span class="n">username</span> <span class="o">==</span> <span class="nb">nil</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="nb">self</span><span class="p">.</span><span class="n">password</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
<span class="lineno">14</span> 	<span class="p">{</span>
<span class="lineno">15</span> 		<span class="p">[</span><span class="bp">NSException</span> <span class="nl">raise</span><span class="p">:</span><span class="s">@&quot;Authentication missing&quot;</span> <span class="nl">format</span><span class="p">:</span><span class="s">@&quot;Username and/or password not set.&quot;</span><span class="p">];</span>
<span class="lineno">16</span> 	<span class="p">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="c1">// No client is predefined and should be instantiated with the right credentials.</span>
<span class="lineno">19</span> 	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
<span class="lineno">20</span> 		<span class="nb">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="p">[</span><span class="n">LRResty</span> <span class="nl">authenticatedClientWithUsername</span><span class="p">:</span><span class="n">username</span> <span class="nl">password</span><span class="p">:</span><span class="n">password</span><span class="p">];</span>
<span class="lineno">21</span> 
<span class="lineno">22</span> 	<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Requesting data from: %@&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
<span class="lineno">23</span> 
<span class="lineno">24</span> 	<span class="p">[</span><span class="n">client</span> <span class="nl">get</span><span class="p">:</span><span class="n">url</span> <span class="nl">withBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">LRRestyResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">25</span> <span class="c1">// Grab the headers of the response</span>
<span class="lineno">26</span> 		<span class="bp">NSDictionary</span><span class="o">*</span> <span class="n">dict</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">;</span>
<span class="lineno">27</span> 
<span class="lineno">28</span> <span class="c1">// Check if the request was finished without errors, if there were no errors, execute our &#39;success&#39; block.</span>
<span class="lineno">29</span> <span class="c1">// Otherwise execute our &#39;failed&#39; block.</span>
<span class="lineno">30</span> <span class="c1">// The response is a parameter for our success and failed block.</span>
<span class="lineno">31</span> 		<span class="k">if</span> <span class="p">([[</span><span class="n">dict</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="s">@&quot;Status&quot;</span><span class="p">]</span> <span class="nl">isEqualToString</span><span class="p">:</span><span class="s">@&quot;200 OK&quot;</span><span class="p">])</span>
<span class="lineno">32</span> 		<span class="p">{</span>
<span class="lineno">33</span> 			<span class="n">success</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="lineno">34</span> 		<span class="p">}</span>
<span class="lineno">35</span> 		<span class="k">else</span>
<span class="lineno">36</span> 		<span class="p">{</span>
<span class="lineno">37</span> 			<span class="n">failed</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="lineno">38</span> 		<span class="p">}</span>
<span class="lineno">39</span> 	<span class="p">}];</span>
<span class="lineno">40</span> <span class="p">}</span></code></pre></div>

<p>With this method I can perform any request <strong>I</strong> want using a different thread. I am not a 100% sure this covers it in your cases (it probably doesn’t).</p>

<p>Now, lets see the code which we use to actually call the <strong>startRequest</strong> method:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="lineno"> 1</span> <span class="c1">// This gets a page of gists using the GitHub API. When it is succesfully done it executes a supplied code-block which</span>
<span class="lineno"> 2</span> <span class="c1">// extracts the gists from the response and returns an array. When it fails it will execute a code-block</span>
<span class="lineno"> 3</span> <span class="c1">// which will show an error in the application.</span>
<span class="lineno"> 4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">getGistsForPage:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nv">page</span> <span class="nf">success:</span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="bp">NSArray</span><span class="o">*</span><span class="p">))</span> <span class="nv">succesBlock</span> <span class="nf">failed:</span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="nv">failedBlock</span>
<span class="lineno"> 5</span> <span class="p">{</span>
<span class="lineno"> 6</span> <span class="c1">// Prepare the URL for the request.</span>
<span class="lineno"> 7</span> 	<span class="bp">NSString</span><span class="o">*</span> <span class="n">gistsUrl</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@%@&quot;</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">githubUrl</span><span class="p">,</span> <span class="s">@&quot;/gists&quot;</span><span class="p">];</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c1">// Here I define the code to be executed when the request is completed successfully. As you can see</span>
<span class="lineno">10</span> <span class="c1">// it grabs an array from the response and executes the supplied &#39;successBlock&#39; with that array</span>
<span class="lineno">11</span> <span class="c1">// as a parameter.</span>
<span class="lineno">12</span> 	<span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">success</span><span class="p">)(</span><span class="n">LRRestyResponse</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">LRRestyResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">13</span> 		<span class="bp">NSArray</span><span class="o">*</span> <span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="p">.</span><span class="n">responseData</span> <span class="n">arrayValue</span><span class="p">];</span>
<span class="lineno">14</span> 		<span class="n">succesBlock</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
<span class="lineno">15</span> 	<span class="p">};</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="c1">// This is the code that will be executed when the request fails. It simply executes the</span>
<span class="lineno">18</span> <span class="c1">// supplied failedBlock code.</span>
<span class="lineno">19</span> 	<span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">failed</span><span class="p">)(</span><span class="n">LRRestyResponse</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">LRRestyResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">20</span> 		<span class="n">failedBlock</span><span class="p">();</span>
<span class="lineno">21</span> 	<span class="p">};</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="c1">// Call the startRequest method, with a dictionary which contains our succesBlock, our failedBlock and the URL</span>
<span class="lineno">24</span> <span class="c1">// we created earlier in this method.</span>
<span class="lineno">25</span> 	<span class="p">[</span><span class="bp">NSThread</span> <span class="nl">detachNewThreadSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">startRequest</span><span class="p">:)</span>
<span class="lineno">26</span> 							 <span class="nl">toTarget</span><span class="p">:</span><span class="nb">self</span>
<span class="lineno">27</span> 						   <span class="nl">withObject</span><span class="p">:[</span><span class="bp">NSDictionary</span> <span class="nl">dictionaryWithObjectsAndKeys</span><span class="p">:</span>
<span class="lineno">28</span> 									   <span class="n">success</span><span class="p">,</span> <span class="s">@&quot;success&quot;</span><span class="p">,</span>
<span class="lineno">29</span> 									   <span class="n">failed</span><span class="p">,</span> <span class="s">@&quot;failed&quot;</span><span class="p">,</span>
<span class="lineno">30</span> 									   <span class="n">gistsUrl</span><span class="p">,</span> <span class="s">@&quot;url&quot;</span><span class="p">,</span>
<span class="lineno">31</span> 									   <span class="nb">nil</span><span class="p">]];</span>
<span class="lineno">32</span> <span class="p">}</span></code></pre></div>

<p>It's pretty straightforward. Now just to be complete, I will post the code I use to call the <strong>getGistsForPage</strong> method too, so you get a complete picture:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="lineno"> 1</span> <span class="c1">// Instantiate our API class, containing the methods I described above</span>
<span class="lineno"> 2</span> <span class="n">GitHubAPI</span><span class="o">*</span> <span class="n">api</span> <span class="o">=</span> <span class="p">[[</span><span class="n">GitHubAPI</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL</span><span class="p">:</span><span class="s">@&quot;https://api.github.com&quot;</span><span class="p">];</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="c1">// Make sure the username, password and delegate are set</span>
<span class="lineno"> 5</span> <span class="n">api</span><span class="p">.</span><span class="n">password</span> <span class="o">=</span> <span class="s">@&quot;your_password&quot;</span><span class="p">;</span>
<span class="lineno"> 6</span> <span class="n">api</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="s">@&quot;your_username&quot;</span><span class="p">;</span>
<span class="lineno"> 7</span> <span class="n">api</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c1">// Call the method, which uses the multi-threaded part.</span>
<span class="lineno">10</span> <span class="p">[</span><span class="n">api</span> <span class="nl">getGistsForPage</span><span class="p">:</span><span class="mi">0</span> <span class="nl">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span><span class="o">*</span> <span class="n">array</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">11</span> 	<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Array count: %lu&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">array</span> <span class="n">count</span><span class="p">]);</span>
<span class="lineno">12</span> <span class="p">}</span> <span class="nl">failed</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">13</span> <span class="p">}];</span></code></pre></div>

<p>That’s it, there is nothing more to it. <strong>For me</strong> this works like a charm!</p>

<p>PS. You can still use a delegate with LRResty, instead of the code-blocks. You need to implement this method when using it this way:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="lineno">1</span> <span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">restClient:</span><span class="p">(</span><span class="n">LRRestyClient</span> <span class="o">*</span><span class="p">)</span><span class="nv">client</span> <span class="nf">receivedResponse:</span><span class="p">(</span><span class="n">LRRestyResponse</span> <span class="o">*</span><span class="p">)</span><span class="nv">res</span><span class="p">;</span>
<span class="lineno">2</span> <span class="p">{</span>
<span class="lineno">3</span>   <span class="c1">// do something with the response</span>
<span class="lineno">4</span> <span class="p">}</span></code></pre></div>


  </article>
</div>


<div id="disqus_thread" class="comments">
  <script type="text/javascript">
      var disqus_shortname = 'cocoaninja';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


    </div>

    <footer class="footer">
	<div class="container">
		<p class="text-muted">&copy; 2015 - Wim Haanstra</p>
	</div>
</footer>

	<script type="text/javascript" src="/js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="/js/bootstrap.min.js"></script>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-15884210-11', 'auto');
	  ga('send', 'pageview');
	
	</script>
	
  </body>

</html>
