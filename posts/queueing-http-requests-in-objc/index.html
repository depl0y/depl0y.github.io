<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Queueing HTTP requests in objC</title>
  <meta name="description" content="For WallPaper I download numerous thumbnails from my webserver at the same time. This is causing slowing speeds (to many threads at once), and too much memor...">

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/main.css">
  
<!--  <link rel="stylesheet" href="/css/main.css"> -->
  <link rel="canonical" href="http://cocoa.ninja/posts/queueing-http-requests-in-objc">
  <link rel="alternate" type="application/rss+xml" title="cocoa.ninja" href="http://cocoa.ninja/feed.xml" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>	    
      <a class="navbar-brand" href="/">
         cocoa.ninja
      </a>
    </div>
  
	  <div class="collapse navbar-collapse">
	      <ul class="nav navbar-nav navbar-right">
		      <li>
			  	<a href="https://twitter.com/depl0y">
					<img src="/img/svg/twitter.svg">
				</a>
	        
			</li>
	     
			<li class="icon  icon--github">
				<a href="https://github.com/depl0y">
					<img src="/img/svg/github.svg">
				</a>
			</li>	 
		
		
			<li class="icon icon--mail">
				<a href="mailto:wim@sortedbits.com">
					<img src="/img/svg/mail.svg">
				</a>
			</li>
			
			<li class="icon icon--so">
				<a href="http://stackoverflow.com/users/69313/wim-haanstra">
					<img src="/img/svg/stackoverflow.svg">
				</a>
			</li>
			
			
			<li class="icon icon--so">
				<a href="skype:wimhaanstra" id="skype_call_wim">
					<img src="/img/svg/skype.svg">
				</a>
			</li>
	  	</ul>
	  </div>
  </div>
</nav>


    <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Queueing HTTP requests in objC</h1>
  </header>
</div>

<div class="post-info">
	<div class="author-avatar">
		<img src="http://www.gravatar.com/avatar/0ec84fc5efb4f0dc7db5df8bf6bb41b9.png">
	</div>
	<div class="details">
		<div class="row">
			<div class="col-md-12 author-name">
				Wim Haanstra
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 post-subtitle">
				This post was created on <span class="post-date">April 21, 2010</span>.
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 tags">
		   		
		   			<span class="tag">objC</span>
		   		
			</div>
		</div>
	</div>
</div>


<div class="post">
  <article class="post-content">
    <p>For WallPaper I download numerous thumbnails from my webserver at the same time. This is causing slowing speeds (to many threads at once), and too much memory usage (too much image data cached at once).</p>
<p>So I looked in queueing the downloads and tried (ofcourse) writing my own QueueHandler class. After I written and spend a couple of hours bughunting/testing my QueueuHandler, I came to the <strong>awesome</strong> idea to see what the iPhone SDK supplies for this kind of jobs :D (you DO read my sarcasm, dont you?).<br /><!-- more -->
<a id="more"></a><a id="more-771"></a><br />
I am using <a title="ASIHTTPRequest Website" href="http://allseeing-i.com/ASIHTTPRequest/" target="_blank">ASIHTTPRequest</a> for my web-requests in WallPaper. I will just show you how I queue my downloads and when the download finishes, I put the image in a predefined and created UIImageView.</p>
<p>I first declare a couple of variables in my <strong>.h</strong> file.</p>
<pre>NSMutableArray* downloadQueue;
NSOperationQueue* queue;</pre>
<p>I added some UIImageView's to a view and I put them and the download URL in a NSMutableDictionary, like this:</p>
<pre>NSMutableDictionary* threadArguments = [[NSMutableDictionary alloc] init];

[threadArguments setObject:myUrl forKey:@&quot;url&quot;];
[threadArguments setObject:myImageView forKey:@&quot;iv&quot;];

[self addToDownloadQueue:threadArguments];</pre>
<p>The <strong>addToDownloadQueue</strong> method does something like this after that (<strong>threadArguments</strong> is the parameter the method is receiving).</p>
<pre>// Add the object to the NSMutableArray I got stored.
[downloadQueue addObject:threadArguments];
if (!queue)
{
	queue = [[NSOperationQueue alloc] init];
	[queue setMaxConcurrentOperationCount:1];
}

NSString* threadUrl = [threadArguments valueForKey:@&quot;url&quot;];
NSURL* downloadUrl = [NSURL URLWithString:threadUrl];
ASIHTTPRequest* request = [ASIHTTPRequest requestWithURL:downloadUrl];
[request setDelegate:self];
[request setDidFinishSelector:@selector(downloadDone:)];
[request setDidFailSelector:@selector(downloadFailed:)];</pre>
<p>I put the <strong>MaxConcurrentOperationCount</strong> on <strong>1</strong> to make sure the application sends the requests for thumbnails one by one (going easy on your bandwidth and on my server).</p>
<p>Now we need to implement the FinishSelector and the FailSelector methods to catch the downloads that are finished and put the downloaded image in the pre-created UIImageView.</p>
<pre>- (void)downloadFailed:(ASIHTTPRequest *)request
{
	NSLog(@&quot;Downloading failed?&quot;);
}

- (void)downloadDone:(ASIHTTPRequest *)request
{
	NSString* downloadUrl = [request.url absoluteString];

	NSMutableDictionary* foundObj = nil;

	for (NSMutableDictionary* dict in downloadQueue)
	{
		NSString* queueUrl = [dict valueForKey:@&quot;url&quot;];

		if ([downloadUrl isEqualToString:queueUrl])
		{
			UIImageView* iv = (UIImageView*)[dict valueForKey:@&quot;iv&quot;];
			NSData* imageData = request.rawResponseData;

			if (iv != nil)
				iv.image = [UIImage imageWithData:imageData];

			foundObj = dict;
		}
	}

	if (foundObj != nil)
		[downloadQueue removeObject:foundObj];
}</pre>
<p>*Ok, somehow my code syntax highlighting screws up the indenting.*</p>
<p>Well, I hope you can use something of my weird code.</p>

  </article>
</div>


<div id="disqus_thread" class="comments">
  <script type="text/javascript">
      var disqus_shortname = 'cocoaninja';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


    </div>

    <footer class="footer">
	<div class="container">
		<p class="text-muted">&copy; 2015 - Wim Haanstra</p>
	</div>
</footer>

	<script type="text/javascript" src="/js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="/js/bootstrap.min.js"></script>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-15884210-11', 'auto');
	  ga('send', 'pageview');
	
	</script>
	
  </body>

</html>
